<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>Excel 上傳到 MongoDB</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/static/main.css" />
  </head>
  <body>
    <div class="main-layout">
      <nav class="sidebar">
        <h2>功能選單</h2>
        <a href="#home" id="nav-home">首頁</a>
        <a href="#inventory" id="nav-inventory">庫存管理</a>
        <a href="#shipping" id="nav-shipping">進出貨管理</a>
        <a href="#material" id="nav-material">物料資訊管理</a>
        <a href="#pick" id="nav-pick">撿貨資訊表</a>
      </nav>
      <div class="content">
        <div id="page-home" class="card">
          <h3>資料庫匯入功能</h3>
          <div class="card">
            <h3>匯入採購與出貨表</h3>
            <form id="upload-purchase-shipping-form" enctype="multipart/form-data">
              <input type="file" id="purchase-shipping-file-input" name="file" accept=".xlsx" />
              <br />
              <button type="submit">匯入 Excel 採購與出貨表</button>
            </form>
            <div id="upload-purchase-shipping-result"></div>
          </div>
          <div class="card">
            <h3>匯入庫存與採購需求表</h3>
            <form id="upload-inventory-need-form" enctype="multipart/form-data">
              <input type="file" id="inventory-need-file-input" name="file" accept=".xlsx" />
              <br />
              <button type="submit">匯入 Excel 庫存與採購需求表</button>
            </form>
            <div id="upload-inventory-need-result"></div>
          </div>
          <div class="card">
            <h3>匯入客戶需求表</h3>
            <form id="upload-customer-need-form" enctype="multipart/form-data">
              <input type="file" id="customer-need-file-input" name="file" accept=".xlsx" />
              <br />
              <button type="submit">匯入 Excel 客戶需求表</button>
            </form>
            <div id="upload-customer-need-result"></div>
          </div>
        </div>
        <div id="page-inventory" class="card" style="display:none;">
          <h3>庫存管理</h3>
          <div>（此頁面暫時空白，可自訂內容）</div>
        </div>
        <div id="page-shipping" class="card" style="display:none;">
          <h3>進出貨管理</h3>
          <div>（此頁面暫時空白，可自訂內容）</div>
        </div>
        <div id="page-material" class="card" style="display:none;">
          <h3>物料資訊管理</h3>
          <div>（此頁面暫時空白，可自訂內容）</div>
        </div>
        <div id="page-pick" class="card" style="display:none; width:100%; box-sizing:border-box;">
          <h3>撿貨資訊表</h3>
          <form id="pick-search-form" style="margin-bottom:1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
            <div style="display:flex; gap:1rem; align-items:center; flex:1;">
              <label for="pick-mic-start" style="margin-bottom:0;">MIC需求起日區間：</label>
              <input type="date" id="pick-mic-start" name="mic_start" required style="width:160px;" />
              <span style="font-size:1.2em;">～</span>
              <input type="date" id="pick-mic-end" name="mic_end" required style="width:160px;" />
              <button type="submit" style="margin-left:1rem;">搜尋</button>
            </div>
            <div style="height:1rem;"></div>
            <div style="display:flex; gap:1rem; align-items:center; flex:1;">
              <label for="pick-sort-field" style="margin-bottom:0;">排序欄位：</label>
              <select id="pick-sort-field" name="sort_field" style="width:140px;">
                <option value="MIC需求起日">MIC需求起日</option>
                <option value="MIC需求訖日">MIC需求訖日</option>
                <option value="料號">料號</option>
                <option value="版本">版本</option>
                <option value="產品中文名稱">產品中文名稱</option>
                <option value="數量">數量</option>
                <option value="單價">單價</option>
                <option value="PO單號">PO單號</option>
                <option value="庫存">庫存</option>
              </select>
              <select id="pick-sort-order" name="sort_order" style="width:80px;">
                <option value="asc">升冪</option>
                <option value="desc">降冪</option>
              </select>
            </div>
          </form>
          <div id="pick-search-result"></div>
        </div>
      </div>
    </div>
    <script>
      // 分頁切換
      function showPage(pageId) {
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-inventory').style.display = 'none';
        document.getElementById('page-shipping').style.display = 'none';
        document.getElementById('page-material').style.display = 'none';
        document.getElementById('page-pick').style.display = 'none';
        document.getElementById(pageId).style.display = '';
        // sidebar active
        document.getElementById('nav-home').classList.remove('active');
        document.getElementById('nav-inventory').classList.remove('active');
        document.getElementById('nav-shipping').classList.remove('active');
        document.getElementById('nav-material').classList.remove('active');
        document.getElementById('nav-pick').classList.remove('active');
        if(pageId==='page-home') document.getElementById('nav-home').classList.add('active');
        if(pageId==='page-inventory') document.getElementById('nav-inventory').classList.add('active');
        if(pageId==='page-shipping') document.getElementById('nav-shipping').classList.add('active');
        if(pageId==='page-material') document.getElementById('nav-material').classList.add('active');
        if(pageId==='page-pick') document.getElementById('nav-pick').classList.add('active');
      }
      document.getElementById('nav-home').onclick = function(){showPage('page-home');};
      document.getElementById('nav-inventory').onclick = function(){showPage('page-inventory');};
      document.getElementById('nav-shipping').onclick = function(){showPage('page-shipping');};
      document.getElementById('nav-material').onclick = function(){showPage('page-material');};
      document.getElementById('nav-pick').onclick = function(){showPage('page-pick');};
      // 預設顯示首頁
      showPage('page-home');
      // 匯入功能
      document.getElementById('upload-purchase-shipping-form').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('purchase-shipping-file-input').files[0]);
        const res = await fetch('/api/upload_purchase_shipping', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        document.getElementById('upload-purchase-shipping-result').innerText = data.ok ? `成功匯入 ${data.inserted} 筆採購與出貨資料` : `錯誤：${data.error}`;
      };
      document.getElementById('upload-inventory-need-form').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('inventory-need-file-input').files[0]);
        const res = await fetch('/api/upload_inventory_need', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        document.getElementById('upload-inventory-need-result').innerText = data.ok ? `成功匯入 ${data.inserted} 筆庫存與採購需求資料` : `錯誤：${data.error}`;
      };
      document.getElementById('upload-customer-need-form').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('customer-need-file-input').files[0]);
        const res = await fetch('/api/upload_customer_need', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        document.getElementById('upload-customer-need-result').innerText = data.ok ? `成功匯入 ${data.inserted} 筆客戶需求資料` : `錯誤：${data.error}`;
      };
      // 撿貨資訊表搜尋功能
      document.getElementById('pick-search-form').onsubmit = async function(e) {
        e.preventDefault();
  const mic_start = document.getElementById('pick-mic-start').value;
  const mic_end = document.getElementById('pick-mic-end').value;
  const sort_field = document.getElementById('pick-sort-field').value;
  const sort_order = document.getElementById('pick-sort-order').value;
  const resultDiv = document.getElementById('pick-search-result');
  // reset table before search
  resultDiv.innerHTML = '';
  const res = await fetch(`/api/search_pick?mic_start=${encodeURIComponent(mic_start)}&mic_end=${encodeURIComponent(mic_end)}&sort_field=${encodeURIComponent(sort_field)}&sort_order=${encodeURIComponent(sort_order)}`);
  const data = await res.json();
        if (!data.ok) {
          resultDiv.innerHTML = `<span style='color:red;'>錯誤：${data.error}</span>`;
          return;
        }
        // 顯示三個資料庫結果
        let html = '';
        for (const [db, rows] of Object.entries(data.data)) {
          if (db === 'customer_need') {
            html += `<div style='display:flex; align-items:center; justify-content:space-between;'>`;
            html += `<h4 style='margin:0;'>客戶需求表</h4>`;
            html += `<div style='display:flex; gap:0.5rem; align-items:center;'>
              <select id='pick-sort-field-inline' style='width:120px;'>
                <option value='MIC需求起日'>MIC需求起日</option>
                <option value='MIC需求訖日'>MIC需求訖日</option>
                <option value='料號'>料號</option>
                <option value='版本'>版本</option>
                <option value='產品中文名稱'>產品中文名稱</option>
                <option value='數量'>數量</option>
                <option value='單價'>單價</option>
                <option value='PO單號'>PO單號</option>
                <option value='庫存'>庫存</option>
              </select>
              <select id='pick-sort-order-inline' style='width:80px;'>
                <option value='asc'>升冪</option>
                <option value='desc'>降冪</option>
              </select>
              <span>排序欄位</span>
              <button id='pick-search-btn-inline' style='margin-left:1rem;'>搜尋</button>
            </div></div>`;
        // 排序欄位 inline 控制
        const sortFieldInline = document.getElementById('pick-sort-field-inline');
        const sortOrderInline = document.getElementById('pick-sort-order-inline');
        const searchBtnInline = document.getElementById('pick-search-btn-inline');
        if (sortFieldInline && sortOrderInline && searchBtnInline) {
          // 預設值與主表單同步
          sortFieldInline.value = document.getElementById('pick-sort-field').value;
          sortOrderInline.value = document.getElementById('pick-sort-order').value;
          sortFieldInline.onchange = function() {
            document.getElementById('pick-sort-field').value = sortFieldInline.value;
          };
          sortOrderInline.onchange = function() {
            document.getElementById('pick-sort-order').value = sortOrderInline.value;
          };
          searchBtnInline.onclick = function(e) {
            e.preventDefault();
            document.getElementById('pick-search-form').dispatchEvent(new Event('submit'));
          };
        }
          }
          if (rows.length === 0) {
            html += '<div>查無資料</div>';
            continue;
          }
          const fields = ["MIC需求起日", "MIC需求訖日", "料號", "版本", "產品中文名稱", "數量", "單價", "PO單號", "庫存"];
          if (db === 'customer_need') {
            html += `<div style='overflow-x:auto;'><table border='1' cellpadding='4' style='margin-bottom:1rem; min-width:1200px;'><thead><tr>`;
            for (const f of fields) html += `<th style='white-space:nowrap;'>${f}</th>`;
            html += '</tr></thead><tbody>';
            for (const row of rows) {
              html += '<tr>';
              for (const f of fields) html += `<td>${row[f] ?? ''}</td>`;
              html += '</tr>';
            }
            html += '</tbody></table></div>';
          } else {
            html += `<h4>${db === 'purchase_shipping' ? '採購與出貨表' : '庫存與採購需求表'}</h4>`;
            html += `<table border='1' cellpadding='4' style='margin-bottom:1rem;'><thead><tr>`;
            for (const f of fields) html += `<th>${f}</th>`;
            html += '</tr></thead><tbody>';
            for (const row of rows) {
              html += '<tr>';
              for (const f of fields) html += `<td>${row[f] ?? ''}</td>`;
              html += '</tr>';
            }
            html += '</tbody></table>';
          }
        }
        resultDiv.innerHTML = html;
        // 排序欄位 inline 控制
        const sortFieldInline = document.getElementById('pick-sort-field-inline');
        const sortOrderInline = document.getElementById('pick-sort-order-inline');
        if (sortFieldInline && sortOrderInline) {
          // 預設值與主表單同步
          sortFieldInline.value = document.getElementById('pick-sort-field').value;
          sortOrderInline.value = document.getElementById('pick-sort-order').value;
          sortFieldInline.onchange = function() {
            document.getElementById('pick-sort-field').value = sortFieldInline.value;
            document.getElementById('pick-search-form').dispatchEvent(new Event('submit'));
          };
          sortOrderInline.onchange = function() {
            document.getElementById('pick-sort-order').value = sortOrderInline.value;
            document.getElementById('pick-search-form').dispatchEvent(new Event('submit'));
          };
        }
      };
    </script>
  </body>
</html>