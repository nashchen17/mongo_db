<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>Excel 上傳到 MongoDB</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/static/main.css" />
  </head>
  <body>
    <div class="main-layout">
      <nav class="sidebar">
        <h2>功能選單</h2>
        <a href="#home" id="nav-home">首頁</a>
        <a href="#inventory" id="nav-inventory">庫存管理</a>
        <a href="#shipping" id="nav-shipping">進出貨管理</a>
        <a href="#material" id="nav-material">物料資訊管理</a>
        <a href="#pick" id="nav-pick">撿貨資訊表</a>
      </nav>
      <div class="content">
        <div id="page-home" class="card">
          <h3>資料庫匯入功能</h3>
          <div class="card">
            <h3>匯入採購與出貨表</h3>
            <form id="upload-purchase-shipping-form" enctype="multipart/form-data">
              <input type="file" id="purchase-shipping-file-input" name="file" accept=".xlsx" />
              <br />
              <button type="submit">匯入 Excel 採購與出貨表</button>
            </form>
            <div id="upload-purchase-shipping-result"></div>
          </div>
          <div class="card">
            <h3>匯入庫存與採購需求表</h3>
            <form id="upload-inventory-need-form" enctype="multipart/form-data">
              <input type="file" id="inventory-need-file-input" name="file" accept=".xlsx" />
              <br />
              <button type="submit">匯入 Excel 庫存與採購需求表</button>
            </form>
            <div id="upload-inventory-need-result"></div>
          </div>
          <div class="card">
            <h3>匯入客戶需求表</h3>
            <form id="upload-customer-need-form" enctype="multipart/form-data">
              <input type="file" id="customer-need-file-input" name="file" accept=".xlsx" />
              <br />
              <button type="submit">匯入 Excel 客戶需求表</button>
            </form>
            <div id="upload-customer-need-result"></div>
          </div>
        </div>
        <div id="page-inventory" class="card" style="display:none;">
          <h3>庫存管理</h3>
          <div>
            <div class="card">
              <h4>入庫（Stock In）</h4>
              <form id="stock-in-form">
                <label>料號: <input type="text" id="in-part-no" required /></label>
                <label>數量: <input type="number" id="in-qty" step="any" required style="width:120px;"/></label>
                <label>單價: <input type="number" id="in-unit-price" step="any" style="width:120px;"/></label>
                <button type="submit">入庫</button>
              </form>
              <div id="stock-in-result"></div>
            </div>
            <div class="card">
              <h4>出庫（Stock Out）</h4>
              <form id="stock-out-form">
                <label>料號: <input type="text" id="out-part-no" required /></label>
                <label>數量: <input type="number" id="out-qty" step="any" required style="width:120px;"/></label>
                <label>允許負庫: <input type="checkbox" id="out-allow-neg" /></label>
                <button type="submit">出庫</button>
              </form>
              <div id="stock-out-result"></div>
            </div>
            <div class="card">
              <h4>查詢庫存</h4>
              <form id="stock-query-form" style="display:flex; gap:8px; align-items:center;">
                <label>料號: <input type="text" id="query-part-no" /></label>
                <button type="submit">查詢</button>
                <button type="button" id="query-all-btn">顯示全部</button>
              </form>
              <div id="stock-query-result"></div>
            </div>
          </div>
        </div>
        <div id="page-shipping" class="card" style="display:none;">
          <h3>進出貨管理</h3>
          <div style="display:flex; gap:1rem; flex-direction:column;">
            <div style="display:flex; gap:1rem; align-items:center;">
              <button id="import-from-pick-btn" style="padding:8px 12px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;">從撿貨資訊匯入出貨</button>
              <button id="select-all-shipping-btn" style="padding:6px 10px;">全選/反選</button>
              <button id="clear-shipping-btn" style="padding:6px 10px;">清除列表</button>
              <!-- per-row 單據編號 controls shown in table rows; global date/serial removed -->
              <!-- 新增排序與匯出按鈕（與撿貨頁面相同） -->
              <label style="margin-left:1rem;">排序欄位：</label>
              <select id="shipping-sort-field" style="width:160px; height:34px;">
                <option value="MIC需求起日">MIC需求起日</option>
                <option value="MIC需求訖日">MIC需求訖日</option>
                <option value="料號">料號</option>
                <option value="版本">版本</option>
                <option value="產品中文名稱">產品中文名稱</option>
                <option value="數量">數量</option>
                <option value="單價">單價</option>
                <option value="PO單號">PO單號</option>
                <option value="庫存">庫存</option>
              </select>
              <select id="shipping-sort-order" style="width:80px; height:34px;">
                <option value="asc">升冪</option>
                <option value="desc">降冪</option>
              </select>
              <button id="shipping-export-excel-btn" style="background-color: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; margin-left:8px; height:34px; line-height:1;">匯出Excel</button>
            </div>
            <div id="shipping-list-container" style="overflow-x:auto; margin-top:8px;"></div>
            <div style="display:flex; gap:1rem; align-items:center; margin-top:8px;">
              <button id="create-shipping-btn" style="padding:8px 12px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;">建立出貨</button>
              <div id="create-shipping-result"></div>
            </div>
          </div>
        </div>
        <div id="page-material" class="card" style="display:none;">
          <h3>物料資訊管理</h3>
          <div>（此頁面暫時空白，可自訂內容）</div>
        </div>
        <div id="page-pick" class="card" style="display:none; width:100%; box-sizing:border-box;">
          <h3>撿貨資訊表</h3>
          <form id="pick-search-form" style="margin-bottom:1rem; display:flex; gap:1rem; align-items:baseline; flex-wrap:wrap;">
            <div style="display:flex; gap:1rem; align-items:baseline; width:100%; margin-bottom:0.5rem;">
              <label for="pick-mic-start" style="margin-bottom:0; min-width:120px; line-height:1;">MIC需求起日區間：</label>
              <input type="date" id="pick-mic-start" name="mic_start" required style="width:160px; height:34px;" />
              <span style="font-size:1.2em; line-height:1;">～</span>
              <input type="date" id="pick-mic-end" name="mic_end" required style="width:160px; height:34px;" />
              <button id="pick-search-btn" type="submit" style="margin-left:1rem; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; height:34px; line-height:1;">搜尋</button>
            </div>
            <div style="display:flex; gap:1rem; align-items:center; width:100%;">
              <label for="pick-sort-field" style="margin-bottom:0; min-width:80px; line-height:1;">排序欄位：</label>
              <select id="pick-sort-field" name="sort_field" style="width:140px; height:34px;">
                <option value="MIC需求起日">MIC需求起日</option>
                <option value="MIC需求訖日">MIC需求訖日</option>
                <option value="料號">料號</option>
                <option value="版本">版本</option>
                <option value="產品中文名稱">產品中文名稱</option>
                <option value="數量">數量</option>
                <option value="單價">單價</option>
                <option value="PO單號">PO單號</option>
                <option value="庫存">庫存</option>
              </select>
              <select id="pick-sort-order" name="sort_order" style="width:80px; height:34px;">
                <option value="asc">升冪</option>
                <option value="desc">降冪</option>
              </select>
              <button id="export-excel-btn" style="background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; display: none; margin-left: 2rem; height:34px; line-height:1;">匯出Excel</button>
              <button id="pick-select-all-btn" style="background-color:#007bff;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;margin-left:8px;height:34px;line-height:1;">全選/反選</button>
            </div>
          </form>
          <div id="pick-search-result"></div>
        </div>
      </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
      // 分頁切換
      function showPage(pageId) {
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-inventory').style.display = 'none';
        document.getElementById('page-shipping').style.display = 'none';
        document.getElementById('page-material').style.display = 'none';
        document.getElementById('page-pick').style.display = 'none';
        document.getElementById(pageId).style.display = '';
        // sidebar active
        document.getElementById('nav-home').classList.remove('active');
        document.getElementById('nav-inventory').classList.remove('active');
        document.getElementById('nav-shipping').classList.remove('active');
        document.getElementById('nav-material').classList.remove('active');
        document.getElementById('nav-pick').classList.remove('active');
        if(pageId==='page-home') document.getElementById('nav-home').classList.add('active');
        if(pageId==='page-inventory') document.getElementById('nav-inventory').classList.add('active');
        if(pageId==='page-shipping') document.getElementById('nav-shipping').classList.add('active');
        if(pageId==='page-material') document.getElementById('nav-material').classList.add('active');
        if(pageId==='page-pick') document.getElementById('nav-pick').classList.add('active');
      }
      document.getElementById('nav-home').onclick = function(){showPage('page-home');};
      document.getElementById('nav-inventory').onclick = function(){showPage('page-inventory');};
      document.getElementById('nav-shipping').onclick = function(){showPage('page-shipping');};
      document.getElementById('nav-material').onclick = function(){showPage('page-material');};
      document.getElementById('nav-pick').onclick = function(){showPage('page-pick');};
      // 預設顯示首頁
      showPage('page-home');
      // Global document-date and document-serial removed; per-row controls used.
      // parse a docNo like 20251012-01 into {dateVal: 'yyyy-mm-dd', serial: '01'}
      function parseDocNoToParts(docNo) {
        const defaultDate = '';
        const defaultSerial = '01';
        if (!docNo) return { dateVal: defaultDate, serial: defaultSerial };
        const m = String(docNo).match(/^(\d{8})-(\d{2})$/);
        if (!m) return { dateVal: defaultDate, serial: defaultSerial };
        const yyyymmdd = m[1];
        const yyyy = yyyymmdd.slice(0,4);
        const mm = yyyymmdd.slice(4,6);
        const dd = yyyymmdd.slice(6,8);
        return { dateVal: `${yyyy}-${mm}-${dd}`, serial: m[2] };
      }
      // build serial <option> list (01..20) with an optional selected value
      function buildSerialOptions(selected) {
        let s = '';
        for (let i=1;i<=20;i++) {
          const v = String(i).padStart(2,'0');
          s += `<option value="${v}" ${v===selected ? 'selected' : ''}>${v}</option>`;
        }
        return s;
      }
  // per-row controls drive shipping table re-rendering; global date/serial controls were removed
      // 進出貨管理前端 JS
      document.getElementById('stock-in-form').onsubmit = async function(e) {
        e.preventDefault();
        const part_no = document.getElementById('in-part-no').value.trim();
        const qty = document.getElementById('in-qty').value;
        const unit_price = document.getElementById('in-unit-price').value;
        const payload = { part_no, qty: Number(qty), unit_price: unit_price ? Number(unit_price) : undefined };
        const res = await fetch('/api/stock/in', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        document.getElementById('stock-in-result').innerText = data.ok ? `入庫成功: ${JSON.stringify(data.tx)}` : `錯誤: ${data.error}`;
      };

      document.getElementById('stock-out-form').onsubmit = async function(e) {
        e.preventDefault();
        const part_no = document.getElementById('out-part-no').value.trim();
        const qty = document.getElementById('out-qty').value;
        const allow_negative = document.getElementById('out-allow-neg').checked;
        const payload = { part_no, qty: Number(qty), allow_negative };
        const res = await fetch('/api/stock/out', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        document.getElementById('stock-out-result').innerText = data.ok ? `出庫成功: 庫存更新 ${data.stock_before} -> ${data.stock_after}` : `錯誤: ${data.error}`;
      };

      async function queryStock(part_no) {
        const url = part_no ? `/api/stock?part_no=${encodeURIComponent(part_no)}` : `/api/stock`;
        const res = await fetch(url);
        const data = await res.json();
        const div = document.getElementById('stock-query-result');
        if (!data.ok) { div.innerText = `錯誤: ${data.error}`; return; }
        if (data.count === 0) { div.innerText = '查無資料'; return; }
        let html = `<table border='1' cellpadding='4'><thead><tr><th>料號</th><th>庫存</th><th>單價</th></tr></thead><tbody>`;
        data.items.forEach(it => {
          html += `<tr><td>${it.part_no}</td><td>${it.stock ?? 0}</td><td>${it.unit_price ?? ''}</td></tr>`;
        });
        html += `</tbody></table>`;
        div.innerHTML = html;
      }

      document.getElementById('stock-query-form').onsubmit = function(e) {
        e.preventDefault();
        const part_no = document.getElementById('query-part-no').value.trim();
        queryStock(part_no || undefined);
      };
      document.getElementById('query-all-btn').onclick = function() { queryStock(); };
      // 匯入功能
      document.getElementById('upload-purchase-shipping-form').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('purchase-shipping-file-input').files[0]);
        const res = await fetch('/api/upload_purchase_shipping', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        document.getElementById('upload-purchase-shipping-result').innerText = data.ok ? `成功匯入 ${data.inserted} 筆採購與出貨資料` : `錯誤：${data.error}`;
      };
      document.getElementById('upload-inventory-need-form').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('inventory-need-file-input').files[0]);
        const res = await fetch('/api/upload_inventory_need', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        document.getElementById('upload-inventory-need-result').innerText = data.ok ? `成功匯入 ${data.inserted} 筆庫存與採購需求資料` : `錯誤：${data.error}`;
      };
      document.getElementById('upload-customer-need-form').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('customer-need-file-input').files[0]);
        const res = await fetch('/api/upload_customer_need', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        document.getElementById('upload-customer-need-result').innerText = data.ok ? `成功匯入 ${data.inserted} 筆客戶需求資料` : `錯誤：${data.error}`;
      };
      // 撿貨資訊表搜尋功能
        // 前端排序用暫存
        let pickSearchData = null;
        function sortRows(rows, field, order) {
          const numericFields = ["數量", "單價", "版本", "庫存"];
          return rows.slice().sort((a, b) => {
            let va = a[field], vb = b[field];
            if (numericFields.includes(field)) {
              va = Number(va) || 0;
              vb = Number(vb) || 0;
            } else if (field.includes("日")) {
              va = va ? new Date(va) : new Date(0);
              vb = vb ? new Date(vb) : new Date(0);
            } else {
              va = va ? va.toString() : "";
              vb = vb ? vb.toString() : "";
            }
            if (va < vb) return order === "asc" ? -1 : 1;
            if (va > vb) return order === "asc" ? 1 : -1;
            return 0;
          });
        }
        function renderPickTable(data, sort_field, sort_order) {
          const resultDiv = document.getElementById('pick-search-result');
          let html = '';
          for (const [db, rows] of Object.entries(data)) {
            let sortedRows = sortRows(rows, sort_field, sort_order);
            const fields = ["MIC需求起日", "MIC需求訖日", "料號", "版本", "產品中文名稱", "數量", "單價", "PO單號", "庫存"];
            // 新增頭欄位 "可出貨"
            if (db === 'customer_need') {
              html += `<div style='overflow-x:auto;'><table border='1' cellpadding='4' style='margin-bottom:1rem; min-width:1200px;'><thead><tr>`;
              for (const f of fields) html += `<th style='white-space:nowrap;'>${f}</th>`;
              html += `<th>可出貨</th>`;
              html += '</tr></thead><tbody>';
              for (const row of sortedRows) {
                // 每列加上 "可出貨" checkbox，data-key 用來識別該列
                const key = rowKey(row, db);
                const inShip = shippingItems.some(si => (si.sources || []).some(s => s.key === key));
                html += '<tr>';
                for (const f of fields) html += `<td>${row[f] ?? ''}</td>`;
                html += `<td style="text-align:center;"><input type="checkbox" class="pick-add-ship" data-key="${key}" ${inShip ? 'checked' : ''} /> 加入</td>`;
                html += '</tr>';
              }
              html += '</tbody></table></div>';
            } else {
              html += `<h4>${db === 'purchase_shipping' ? '採購與出貨表' : '庫存與採購需求表'}</h4>`;
              html += `<table border='1' cellpadding='4' style='margin-bottom:1rem;'><thead><tr>`;
              for (const f of fields) html += `<th>${f}</th>`;
              html += `<th>可出貨</th>`;
              html += '</tr></thead><tbody>';
              for (const row of sortedRows) {
                const key = rowKey(row, db);
                const inShip = shippingItems.some(si => (si.sources || []).some(s => s.key === key));
                html += '<tr>';
                for (const f of fields) html += `<td>${row[f] ?? ''}</td>`;
                html += `<td style="text-align:center;"><input type="checkbox" class="pick-add-ship" data-key="${key}" ${inShip ? 'checked' : ''} /> 加入</td>`;
                html += '</tr>';
              }
              html += '</tbody></table>';
            }
          }
          resultDiv.innerHTML = html;
          // 綁定每列的「可出貨」checkbox（加入/移除出貨清單）
          resultDiv.querySelectorAll('.pick-add-ship').forEach(cb => {
            cb.onchange = function() {
              const key = this.getAttribute('data-key');
              if (this.checked) {
                addPickRowToShipping(key);
              } else {
                removePickRowFromShipping(key);
              }
            };
          });
          // 全選/反選 按鈕行為：切換所有 pick-add-ship 的勾選並觸發 onchange
          const pickSelectAllBtn = document.getElementById('pick-select-all-btn');
          if (pickSelectAllBtn) {
            pickSelectAllBtn.onclick = function() {
              const checkboxes = Array.from(resultDiv.querySelectorAll('.pick-add-ship'));
              if (checkboxes.length === 0) return;
              // 若至少存在一個未勾選，則勾選全部；否則取消勾選全部
              const anyUnchecked = checkboxes.some(cb => !cb.checked);
              checkboxes.forEach(cb => {
                if (cb.checked !== anyUnchecked) {
                  cb.checked = anyUnchecked;
                  // 直接呼叫 onchange handler（若有）以同步 shippingItems
                  if (typeof cb.onchange === 'function') cb.onchange();
                }
              });
            };
          }
          // 排序欄位 inline 控制
          const sortFieldInline = document.getElementById('pick-sort-field-inline');
          const sortOrderInline = document.getElementById('pick-sort-order-inline');
          const searchBtnInline = document.getElementById('pick-search-btn-inline');
          if (sortFieldInline && sortOrderInline && searchBtnInline) {
            sortFieldInline.value = document.getElementById('pick-sort-field').value;
            sortOrderInline.value = document.getElementById('pick-sort-order').value;
            sortFieldInline.onchange = function() {
              document.getElementById('pick-sort-field').value = sortFieldInline.value;
              renderPickTable(pickSearchData, sortFieldInline.value, sortOrderInline.value);
            };
            sortOrderInline.onchange = function() {
              document.getElementById('pick-sort-order').value = sortOrderInline.value;
              renderPickTable(pickSearchData, sortFieldInline.value, sortOrderInline.value);
            };
            searchBtnInline.onclick = function(e) {
              e.preventDefault();
              renderPickTable(pickSearchData, sortFieldInline.value, sortOrderInline.value);
            };
          }
        }
        // 產生每列的唯一 key（用於識別與加入/移除）
        function rowKey(row, db) {
          return `${db}|${row['MIC需求起日']||''}|${row['料號']||''}|${row['版本']||''}|${row['PO單號']||''}`;
        }
        // 從 pickSearchData 找回 row 物件
        function findRowByKey(key) {
          for (const [db, rows] of Object.entries(pickSearchData || {})) {
            for (const r of rows) {
              if (rowKey(r, db) === key) return { db, row: r };
            }
          }
          return null;
        }
        // 產生聚合 key（以 料號 + PO 單號 為主）
        function aggrKeyFromRow(row) {
          return `${row['料號']||''}|${row['PO單號']||''}`;
        }

        // 加入單一 pick 列到 shippingItems（若同一料號+PO 已存在，則加總；同時記錄來源 row key）
        function addPickRowToShipping(key) {
          if (!pickSearchData) return;
          const found = findRowByKey(key);
          if (!found) return;
          const r = found.row;
          const qty = Number(r['數量'] || 0);
          const merged = mergePartVersion(r);
          const aggr = aggrKeyFromRow(r);

          // 若已存在相同聚合 key，則累加數量並記錄來源
          const existIdx = shippingItems.findIndex(si => si.aggrKey === aggr);
          if (existIdx >= 0) {
            const si = shippingItems[existIdx];
            si.qty = (Number(si.qty) || 0) + qty;
            si.ship_qty = (Number(si.ship_qty) || 0) + qty;
            // stamp current composed document number into the aggregated item
            // prefer existing si.doc_no or rawRow's 單據編號; do not rely on global composed value
            si.doc_no = si.doc_no || (r['單據編號'] || '');
            // 優先保留已有的 product/unit_price/stock，若不存在則採用新 row 的值
            if (!si.product) si.product = r['產品中文名稱'] || '';
            if (!si.unit_price) si.unit_price = r['單價'] || '';
            if (!si.stock) si.stock = r['庫存'] || '';
            // 記錄來源 key（避免重複加入同一來源）
            si.sources = si.sources || [];
            if (!si.sources.some(s => s.key === key)) si.sources.push({ key, qty });
          } else {
            // 新增聚合項目
            const newItem = {
              id: (shippingItems.length ? Math.max(...shippingItems.map(s => s.id)) + 1 : 1),
              db: found.db,
              rawRow: r,
              part_no: r['料號'] || '',
              version: r['版本'] || '',
              merged,
              product: r['產品中文名稱'] || '',
              qty: qty,
              unit_price: r['單價'] || '',
              po: r['PO單號'] || '',
              stock: r['庫存'] || '',
              ship_qty: qty,
              selected: true,
              // stamp per-item doc_no from source row if present
              doc_no: (r['單據編號'] || ''),
              aggrKey: aggr,
              sources: [{ key, qty }]
            };
            shippingItems.push(newItem);
          }
          renderShippingTable();
        }
        // 從 shippingItems 移除對應 pick row 的貢獻（以來源 key 為準），若該 shipping 項目 no sources 則移除整筆；
        // 同時在 pick 表格取消對應 checkbox（若仍在畫面上）
        function removePickRowFromShipping(key) {
          // 找出包含此來源 key 的 shipping item
          const idx = shippingItems.findIndex(si => (si.sources || []).some(s => s.key === key));
          if (idx >= 0) {
            const si = shippingItems[idx];
            // 找回來源並扣除數量
            const srcIdx = si.sources.findIndex(s => s.key === key);
            if (srcIdx >= 0) {
              const src = si.sources[srcIdx];
              const qty = Number(src.qty) || 0;
              si.qty = (Number(si.qty) || 0) - qty;
              si.ship_qty = (Number(si.ship_qty) || 0) - qty;
              // 移除該來源
              si.sources.splice(srcIdx, 1);
            }
            // 若沒有來源或數量 <= 0，移除整筆 shipping item
            if (!si.sources || si.sources.length === 0 || (Number(si.qty) || 0) <= 0) {
              shippingItems.splice(idx, 1);
            }
          }
          renderShippingTable();
          // 若 pick 表格仍在畫面上，取消對應 checkbox
          const cb = document.querySelector(`.pick-add-ship[data-key="${key}"]`);
          if (cb) cb.checked = false;
        }
        // 主排序欄位監聽
        document.getElementById('pick-sort-field').onchange = function() {
          if (pickSearchData) {
            renderPickTable(pickSearchData, this.value, document.getElementById('pick-sort-order').value);
          }
        };
        document.getElementById('pick-sort-order').onchange = function() {
          if (pickSearchData) {
            renderPickTable(pickSearchData, document.getElementById('pick-sort-field').value, this.value);
          }
        };
        async function performPickSearch(e) {
          console.log('performPickSearch start', e);
          try { if (e && typeof e.preventDefault === 'function') e.preventDefault(); } catch(err) {}
          const resultDiv = document.getElementById('pick-search-result');
          try {
            const mic_start = document.getElementById('pick-mic-start').value;
            const mic_end = document.getElementById('pick-mic-end').value;
            const sort_field = document.getElementById('pick-sort-field').value;
            const sort_order = document.getElementById('pick-sort-order').value;
            resultDiv.innerHTML = '';
            const res = await fetch(`/api/search_pick?mic_start=${encodeURIComponent(mic_start)}&mic_end=${encodeURIComponent(mic_end)}`);
            const data = await res.json();
            if (!data.ok) {
              resultDiv.innerHTML = `<span style='color:red;'>錯誤：${data.error}</span>`;
              pickSearchData = null;
            } else {
              pickSearchData = data.data;
              renderPickTable(pickSearchData, sort_field, sort_order);
              document.getElementById('export-excel-btn').style.display = 'inline-block';
            }
          } catch (ex) {
            console.error('pick search failed', ex);
            if (resultDiv) resultDiv.innerHTML = `<span style='color:red;'>執行錯誤: ${ex && ex.message ? ex.message : String(ex)}</span>`;
          }
          try { showPage('page-pick'); } catch(e) {}
          console.log('performPickSearch end');
        }
        document.getElementById('pick-search-form').onsubmit = performPickSearch;
        const pickSearchBtn = document.getElementById('pick-search-btn');
        if (pickSearchBtn) pickSearchBtn.onclick = performPickSearch;

        // 匯出Excel功能（產生真正的 .xlsx 檔案，使用 SheetJS）
        document.getElementById('export-excel-btn').onclick = function() {
          if (!pickSearchData) return;
          const sort_field = document.getElementById('pick-sort-field').value;
          const sort_order = document.getElementById('pick-sort-order').value;

          // 準備匯出資料（保持與之前 CSV 相同的資料排列）
          let exportData = [];
          for (const [db, rows] of Object.entries(pickSearchData)) {
            let sortedRows = sortRows(rows, sort_field, sort_order);
            const dbName = db === 'customer_need' ? '客戶需求表' : 
                          db === 'purchase_shipping' ? '採購與出貨表' : '庫存與採購需求表';

            if (exportData.length > 0) {
              exportData.push({});
            }
            exportData.push({ 'MIC需求起日': dbName });
            exportData.push({});

            exportData.push({
              'MIC需求起日': 'MIC需求起日',
              'MIC需求訖日': 'MIC需求訖日',
              // 料號 與 版本 合併成單一欄位（版本標示為「版本X」並與料號以三個空格分隔）
              '料號': '料號',
              '產品中文名稱': '產品中文名稱',
              '數量': '數量',
              '單價': '單價',
              'PO單號': 'PO單號',
              '庫存': '庫存'
            });

            sortedRows.forEach(row => {
              // 合併料號與版本：若版本存在則前面加上「版本」字樣，並與料號以三個空格分隔
              const part料號 = row['料號'] || '';
              const part版本 = row['版本'] ? ('版本' + row['版本']) : '';
              const merged料號版本 = part版本 ? (part料號 + '   ' + part版本) : part料號;
              // 在 PO 單號後面加上：一個空格 + 'Rev.: 00'
              const poRaw = row['PO單號'] || '';
              const poWithRev = poRaw ? (poRaw + ' Rev.: 00') : '';
              exportData.push({
                'MIC需求起日': row['MIC需求起日'] || '',
                'MIC需求訖日': row['MIC需求訖日'] || '',
                '料號': merged料號版本,
                '產品中文名稱': row['產品中文名稱'] || '',
                '數量': row['數量'] || '',
                '單價': row['單價'] || '',
                'PO單號': poWithRev,
                '庫存': row['庫存'] || ''
              });
            });
          }

          // 欄位順序（已將 版本 與 料號 合併為單一欄位）
          const fields = ['MIC需求起日', 'MIC需求訖日', '料號', '產品中文名稱', '數量', '單價', 'PO單號', '庫存'];

          // 轉成 AOA（array of arrays）以確保 Excel 中每列位置正確
          const aoa = [];
          exportData.forEach(row => {
            // row 可能是空物件（分隔列）或只有第一欄有值（DB 名稱或單欄標題）
            const arr = fields.map(f => {
              return row[f] || '';
            });
            // 如果整列都是空字串，推入空陣列以避免出現多個空儲存格
            const allEmpty = arr.every(v => v === '');
            aoa.push(allEmpty ? [] : arr);
          });

          // 建立 worksheet 與 workbook
          const ws = XLSX.utils.aoa_to_sheet(aoa);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, '撿貨資訊表');

          // 產生二進位 ArrayBuffer 並建立 Blob 供下載
          const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
          const blob = new Blob([wbout], { type: 'application/octet-stream' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          const today = new Date().toISOString().split('T')[0];
          link.download = `撿貨資訊表_${today}.xlsx`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        };
       // --- 進出貨管理前端：從撿貨資訊匯入並建立出貨 --------------------
       // 物流資料來源為全域變數 pickSearchData（由撿貨搜尋產生）
       let shippingItems = []; // {id, db, rawRow, part_no, version, merged, product, qty, unit_price, po, stock, ship_qty, selected}

       function resetShippingList() {
         shippingItems = [];
         renderShippingTable();
         document.getElementById('create-shipping-result').innerText = '';
       }

       function mergePartVersion(row) {
         const part = row['料號'] || '';
         const ver = row['版本'] ? ('版本' + row['版本']) : '';
         return ver ? (part + '   ' + ver) : part;
       }

       function importPickToShipping() {
         if (!pickSearchData) {
           alert('請先至「撿貨資訊表」依需求搜尋並取得資料，然後再匯入。');
           return;
         }
         // 先清空，再逐筆以 addPickRowToShipping 處理，確保會做聚合
         shippingItems = [];
         for (const [db, rows] of Object.entries(pickSearchData)) {
           for (const r of rows) {
             const key = rowKey(r, db);
             addPickRowToShipping(key);
           }
         }
         renderShippingTable();
       }

       function renderShippingTable() {
         const container = document.getElementById('shipping-list-container');
         if (!shippingItems || shippingItems.length === 0) {
           container.innerHTML = '<div>尚無出貨項目，請點「從撿貨資訊匯入出貨」。</div>';
           return;
         }
        // 以使用者選擇的排序欄位排序並顯示
        const sortField = document.getElementById('shipping-sort-field') ? document.getElementById('shipping-sort-field').value : 'MIC需求起日';
        const sortOrder = document.getElementById('shipping-sort-order') ? document.getElementById('shipping-sort-order').value : 'asc';
        function compareByField(a, b, field, order) {
          let va = a.rawRow[field] ?? '';
          let vb = b.rawRow[field] ?? '';
          const numericFields = ["數量", "單價", "版本", "庫存"];
          if (numericFields.includes(field)) { va = Number(va) || 0; vb = Number(vb) || 0; }
          else if (field.includes("日")) { va = va ? new Date(va) : new Date(0); vb = vb ? new Date(vb) : new Date(0); }
          else { va = va ? va.toString() : ''; vb = vb ? vb.toString() : ''; }
          if (va < vb) return order === 'asc' ? -1 : 1;
          if (va > vb) return order === 'asc' ? 1 : -1;
          return 0;
        }
        const sorted = shippingItems.slice().sort((a, b) => compareByField(a, b, sortField, sortOrder));
        let html = `<table border="1" cellpadding="6" style="min-width:1000px;"><thead><tr>
          <th>選取</th><th>料號 / 版本</th>
          <th>數量</th><th>單價</th><th>小計</th><th>PO單號</th><th>單據編號</th>
        </tr></thead><tbody>`;
        for (const it of sorted) {
           const poWithRev = it.po ? (it.po + ' Rev.: 00') : '';
            const qty = Number(it.qty) || 0;
            const unit = Number(it.unit_price) || 0;
            const subtotal = qty * unit;
            // determine per-row date/serial defaults
            const parts = parseDocNoToParts(it.doc_no || ((it.rawRow && it.rawRow['單據編號']) ? it.rawRow['單據編號'] : ''));
            const dateVal = parts.dateVal || '';
            const serialVal = parts.serial || '01';
            const serialOptionsHtml = buildSerialOptions(serialVal);
            html += `<tr data-id="${it.id}">
            <td style="text-align:center;"><input type="checkbox" class="ship-select" ${it.selected ? 'checked' : ''}></td>
            <td style="white-space:nowrap;">${it.merged}</td>
            <td style="text-align:right;">${qty}</td>
            <td style="text-align:right;">${unit}</td>
            <td style="text-align:right;">${subtotal}</td>
            <td>${poWithRev}</td>
            <td style="white-space:nowrap;">
              <input type="date" class="doc-date" value="${dateVal}" style="width:120px;" />
              <select class="doc-serial">${serialOptionsHtml}</select>
            </td>
          </tr>`;
         }
         html += '</tbody></table>';
         container.innerHTML = html;
        // 綁定事件（以 data-id 找回 shippingItems 的 index，避免排序後錯位）
        container.querySelectorAll('tr[data-id]').forEach(tr => {
          const id = Number(tr.getAttribute('data-id'));
          const idx = shippingItems.findIndex(si => si.id === id);
          if (idx < 0) return;
          const cb = tr.querySelector('.ship-select');
          if (cb) cb.onchange = function() { shippingItems[idx].selected = this.checked; };
          // no action column anymore (remove button removed)
          // bind per-row doc date/serial controls to update item.doc_no
          const dateInput = tr.querySelector('.doc-date');
          const serialSel = tr.querySelector('.doc-serial');
          function updateItemDocNo() {
            const dv = dateInput ? dateInput.value.replace(/-/g,'') : '';
            const sv = serialSel ? serialSel.value : '';
            if (dv && sv) shippingItems[idx].doc_no = `${dv}-${sv}`;
            else shippingItems[idx].doc_no = '';
          }
          if (dateInput) dateInput.onchange = updateItemDocNo;
          if (serialSel) serialSel.onchange = updateItemDocNo;
        });
       }
      // 當使用者改變進出貨頁的排序時重繪
      document.getElementById('shipping-sort-field').onchange = function() { renderShippingTable(); };
      document.getElementById('shipping-sort-order').onchange = function() { renderShippingTable(); };

      // 進出貨頁匯出 Excel（只匯出目前 shippingItems，順序照頁面排序）
      document.getElementById('shipping-export-excel-btn').onclick = function() {
        if (!shippingItems || shippingItems.length === 0) { alert('無可匯出的出貨項目'); return; }
        const sortField = document.getElementById('shipping-sort-field').value;
        const sortOrder = document.getElementById('shipping-sort-order').value;
        // 先排序
        function cmp(a,b) {
          let va = a.rawRow[sortField] ?? '';
          let vb = b.rawRow[sortField] ?? '';
          const numericFields = ["數量", "單價", "版本", "庫存"];
          if (numericFields.includes(sortField)) { va = Number(va)||0; vb = Number(vb)||0; }
          else if (sortField.includes("日")) { va = va ? new Date(va) : new Date(0); vb = vb ? new Date(vb) : new Date(0); }
          else { va = va ? va.toString() : ''; vb = vb ? vb.toString() : ''; }
          if (va < vb) return sortOrder === 'asc' ? -1 : 1;
          if (va > vb) return sortOrder === 'asc' ? 1 : -1;
          return 0;
        }
        const sorted = shippingItems.slice().sort(cmp);
        // 準備 AOA (目前出貨欄位：料號, 數量, 單價, 小計, PO單號, 單據編號)
        const fields = ['料號','數量','單價','小計','PO單號','單據編號'];
        const aoa = [];
        // 標題列
        aoa.push(fields);
        // 各列
        sorted.forEach(it => {
          const merged = it.merged || '';
          const poWithRev = it.po ? (it.po + ' Rev.: 00') : '';
          const qty = Number(it.qty) || 0;
          const unit = Number(it.unit_price) || 0;
          const subtotal = qty * unit;
          const docNo = it.doc_no || ((it.rawRow && it.rawRow['單據編號']) ? it.rawRow['單據編號'] : '');
          aoa.push([
            merged,
            qty || '',
            unit || '',
            subtotal || '',
            poWithRev,
            docNo
          ]);
        });
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '出貨清單');
        const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `出貨清單_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };
       // --------------------------------------------------------------
    </script>
  </body>
</html>