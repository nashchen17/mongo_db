<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>Excel 上傳到 MongoDB</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/static/main.css" />
  </head>
  <body>
    <div class="main-layout">
      <nav class="sidebar">
        <h2>功能選單</h2>
        <a href="#home" id="nav-home">首頁</a>
        <a href="#inventory" id="nav-inventory">庫存管理</a>
        <a href="#shipping" id="nav-shipping">進出貨管理</a>
        <a href="#material" id="nav-material">物料資訊管理</a>
        <a href="#pick" id="nav-pick">撿貨資訊表</a>
      </nav>
      <div class="content">
        <div id="page-home" class="card">
          <h3>資料庫匯入功能</h3>
          <div class="card">
            <h3>匯入採購與出貨表</h3>
            <form id="upload-purchase-shipping-form" enctype="multipart/form-data">
              <input type="file" id="purchase-shipping-file-input" name="file" accept=".xlsx" />
              <br />
              <button type="submit">匯入 Excel 採購與出貨表</button>
            </form>
            <div id="upload-purchase-shipping-result"></div>
          </div>
          <div class="card">
            <h3>匯入庫存與採購需求表</h3>
            <form id="upload-inventory-need-form" enctype="multipart/form-data">
              <input type="file" id="inventory-need-file-input" name="file" accept=".xlsx" />
              <br />
              <button type="submit">匯入 Excel 庫存與採購需求表</button>
            </form>
            <div id="upload-inventory-need-result"></div>
          </div>
          <div class="card">
            <h3>匯入客戶需求表</h3>
            <form id="upload-customer-need-form" enctype="multipart/form-data">
              <input type="file" id="customer-need-file-input" name="file" accept=".xlsx" />
              <br />
              <button type="submit">匯入 Excel 客戶需求表</button>
            </form>
            <div id="upload-customer-need-result"></div>
          </div>
        </div>
        <div id="page-inventory" class="card" style="display:none;">
          <h3>庫存管理</h3>
          <div>（此頁面暫時空白，可自訂內容）</div>
        </div>
        <div id="page-shipping" class="card" style="display:none;">
          <h3>進出貨管理</h3>
          <div>（此頁面暫時空白，可自訂內容）</div>
        </div>
        <div id="page-material" class="card" style="display:none;">
          <h3>物料資訊管理</h3>
          <div>（此頁面暫時空白，可自訂內容）</div>
        </div>
        <div id="page-pick" class="card" style="display:none; width:100%; box-sizing:border-box;">
          <h3>撿貨資訊表</h3>
          <form id="pick-search-form" style="margin-bottom:1rem; display:flex; gap:1rem; align-items:baseline; flex-wrap:wrap;">
            <div style="display:flex; gap:1rem; align-items:baseline; width:100%; margin-bottom:0.5rem;">
              <label for="pick-mic-start" style="margin-bottom:0; min-width:120px; line-height:1;">MIC需求起日區間：</label>
              <input type="date" id="pick-mic-start" name="mic_start" required style="width:160px; height:34px;" />
              <span style="font-size:1.2em; line-height:1;">～</span>
              <input type="date" id="pick-mic-end" name="mic_end" required style="width:160px; height:34px;" />
              <button type="submit" style="margin-left:1rem; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; height:34px; line-height:1;">搜尋</button>
            </div>
            <div style="display:flex; gap:1rem; align-items:center; width:100%;">
              <label for="pick-sort-field" style="margin-bottom:0; min-width:80px; line-height:1;">排序欄位：</label>
              <select id="pick-sort-field" name="sort_field" style="width:140px; height:34px;">
                <option value="MIC需求起日">MIC需求起日</option>
                <option value="MIC需求訖日">MIC需求訖日</option>
                <option value="料號">料號</option>
                <option value="版本">版本</option>
                <option value="產品中文名稱">產品中文名稱</option>
                <option value="數量">數量</option>
                <option value="單價">單價</option>
                <option value="PO單號">PO單號</option>
                <option value="庫存">庫存</option>
              </select>
              <select id="pick-sort-order" name="sort_order" style="width:80px; height:34px;">
                <option value="asc">升冪</option>
                <option value="desc">降冪</option>
              </select>
              <button id="export-excel-btn" style="background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; display: none; margin-left: 2rem; height:34px; line-height:1;">匯出Excel</button>
            </div>
          </form>
          <div id="pick-search-result"></div>
        </div>
      </div>
    </div>
    <script>
      // 分頁切換
      function showPage(pageId) {
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-inventory').style.display = 'none';
        document.getElementById('page-shipping').style.display = 'none';
        document.getElementById('page-material').style.display = 'none';
        document.getElementById('page-pick').style.display = 'none';
        document.getElementById(pageId).style.display = '';
        // sidebar active
        document.getElementById('nav-home').classList.remove('active');
        document.getElementById('nav-inventory').classList.remove('active');
        document.getElementById('nav-shipping').classList.remove('active');
        document.getElementById('nav-material').classList.remove('active');
        document.getElementById('nav-pick').classList.remove('active');
        if(pageId==='page-home') document.getElementById('nav-home').classList.add('active');
        if(pageId==='page-inventory') document.getElementById('nav-inventory').classList.add('active');
        if(pageId==='page-shipping') document.getElementById('nav-shipping').classList.add('active');
        if(pageId==='page-material') document.getElementById('nav-material').classList.add('active');
        if(pageId==='page-pick') document.getElementById('nav-pick').classList.add('active');
      }
      document.getElementById('nav-home').onclick = function(){showPage('page-home');};
      document.getElementById('nav-inventory').onclick = function(){showPage('page-inventory');};
      document.getElementById('nav-shipping').onclick = function(){showPage('page-shipping');};
      document.getElementById('nav-material').onclick = function(){showPage('page-material');};
      document.getElementById('nav-pick').onclick = function(){showPage('page-pick');};
      // 預設顯示首頁
      showPage('page-home');
      // 匯入功能
      document.getElementById('upload-purchase-shipping-form').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('purchase-shipping-file-input').files[0]);
        const res = await fetch('/api/upload_purchase_shipping', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        document.getElementById('upload-purchase-shipping-result').innerText = data.ok ? `成功匯入 ${data.inserted} 筆採購與出貨資料` : `錯誤：${data.error}`;
      };
      document.getElementById('upload-inventory-need-form').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('inventory-need-file-input').files[0]);
        const res = await fetch('/api/upload_inventory_need', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        document.getElementById('upload-inventory-need-result').innerText = data.ok ? `成功匯入 ${data.inserted} 筆庫存與採購需求資料` : `錯誤：${data.error}`;
      };
      document.getElementById('upload-customer-need-form').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', document.getElementById('customer-need-file-input').files[0]);
        const res = await fetch('/api/upload_customer_need', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        document.getElementById('upload-customer-need-result').innerText = data.ok ? `成功匯入 ${data.inserted} 筆客戶需求資料` : `錯誤：${data.error}`;
      };
      // 撿貨資訊表搜尋功能
        // 前端排序用暫存
        let pickSearchData = null;
        function sortRows(rows, field, order) {
          const numericFields = ["數量", "單價", "版本", "庫存"];
          return rows.slice().sort((a, b) => {
            let va = a[field], vb = b[field];
            if (numericFields.includes(field)) {
              va = Number(va) || 0;
              vb = Number(vb) || 0;
            } else if (field.includes("日")) {
              va = va ? new Date(va) : new Date(0);
              vb = vb ? new Date(vb) : new Date(0);
            } else {
              va = va ? va.toString() : "";
              vb = vb ? vb.toString() : "";
            }
            if (va < vb) return order === "asc" ? -1 : 1;
            if (va > vb) return order === "asc" ? 1 : -1;
            return 0;
          });
        }
        function renderPickTable(data, sort_field, sort_order) {
          const resultDiv = document.getElementById('pick-search-result');
          let html = '';
          for (const [db, rows] of Object.entries(data)) {
            let sortedRows = sortRows(rows, sort_field, sort_order);
            const fields = ["MIC需求起日", "MIC需求訖日", "料號", "版本", "產品中文名稱", "數量", "單價", "PO單號", "庫存"];
            if (db === 'customer_need') {
              html += `<div style='display:flex; align-items:center; justify-content:space-between;'>`;
              html += `<h4 style='margin:0;'>客戶需求表</h4>`;
              html += `<div style='display:flex; gap:0.5rem; align-items:center;'>
                <select id='pick-sort-field-inline' style='width:120px;'>
                  <option value='MIC需求起日'>MIC需求起日</option>
                  <option value='MIC需求訖日'>MIC需求訖日</option>
                  <option value='料號'>料號</option>
                  <option value='版本'>版本</option>
                  <option value='產品中文名稱'>產品中文名稱</option>
                  <option value='數量'>數量</option>
                  <option value='單價'>單價</option>
                  <option value='PO單號'>PO單號</option>
                  <option value='庫存'>庫存</option>
                </select>
                <select id='pick-sort-order-inline' style='width:80px;'>
                  <option value='asc'>升冪</option>
                  <option value='desc'>降冪</option>
                </select>
                <span>排序欄位</span>
                <button id='pick-search-btn-inline' style='margin-left:1rem;'>搜尋</button>
              </div></div>`;
            }
            if (sortedRows.length === 0) {
              html += '<div>查無資料</div>';
              continue;
            }
            if (db === 'customer_need') {
              html += `<div style='overflow-x:auto;'><table border='1' cellpadding='4' style='margin-bottom:1rem; min-width:1200px;'><thead><tr>`;
              for (const f of fields) html += `<th style='white-space:nowrap;'>${f}</th>`;
              html += '</tr></thead><tbody>';
              for (const row of sortedRows) {
                html += '<tr>';
                for (const f of fields) html += `<td>${row[f] ?? ''}</td>`;
                html += '</tr>';
              }
              html += '</tbody></table></div>';
            } else {
              html += `<h4>${db === 'purchase_shipping' ? '採購與出貨表' : '庫存與採購需求表'}</h4>`;
              html += `<table border='1' cellpadding='4' style='margin-bottom:1rem;'><thead><tr>`;
              for (const f of fields) html += `<th>${f}</th>`;
              html += '</tr></thead><tbody>';
              for (const row of sortedRows) {
                html += '<tr>';
                for (const f of fields) html += `<td>${row[f] ?? ''}</td>`;
                html += '</tr>';
              }
              html += '</tbody></table>';
            }
          }
          resultDiv.innerHTML = html;
          // 排序欄位 inline 控制
          const sortFieldInline = document.getElementById('pick-sort-field-inline');
          const sortOrderInline = document.getElementById('pick-sort-order-inline');
          const searchBtnInline = document.getElementById('pick-search-btn-inline');
          if (sortFieldInline && sortOrderInline && searchBtnInline) {
            sortFieldInline.value = document.getElementById('pick-sort-field').value;
            sortOrderInline.value = document.getElementById('pick-sort-order').value;
            sortFieldInline.onchange = function() {
              document.getElementById('pick-sort-field').value = sortFieldInline.value;
              renderPickTable(pickSearchData, sortFieldInline.value, sortOrderInline.value);
            };
            sortOrderInline.onchange = function() {
              document.getElementById('pick-sort-order').value = sortOrderInline.value;
              renderPickTable(pickSearchData, sortFieldInline.value, sortOrderInline.value);
            };
            searchBtnInline.onclick = function(e) {
              e.preventDefault();
              renderPickTable(pickSearchData, sortFieldInline.value, sortOrderInline.value);
            };
          }
        }
        // 主排序欄位監聽
        document.getElementById('pick-sort-field').onchange = function() {
          if (pickSearchData) {
            renderPickTable(pickSearchData, this.value, document.getElementById('pick-sort-order').value);
          }
        };
        document.getElementById('pick-sort-order').onchange = function() {
          if (pickSearchData) {
            renderPickTable(pickSearchData, document.getElementById('pick-sort-field').value, this.value);
          }
        };
        document.getElementById('pick-search-form').onsubmit = async function(e) {
          e.preventDefault();
          const mic_start = document.getElementById('pick-mic-start').value;
          const mic_end = document.getElementById('pick-mic-end').value;
          const sort_field = document.getElementById('pick-sort-field').value;
          const sort_order = document.getElementById('pick-sort-order').value;
          const resultDiv = document.getElementById('pick-search-result');
          resultDiv.innerHTML = '';
          const res = await fetch(`/api/search_pick?mic_start=${encodeURIComponent(mic_start)}&mic_end=${encodeURIComponent(mic_end)}`);
          const data = await res.json();
          if (!data.ok) {
            resultDiv.innerHTML = `<span style='color:red;'>錯誤：${data.error}</span>`;
            pickSearchData = null;
            return;
          }
          pickSearchData = data.data;
          renderPickTable(pickSearchData, sort_field, sort_order);
          // 顯示匯出按鈕
          document.getElementById('export-excel-btn').style.display = 'inline-block';
        };

        // 匯出Excel功能
        document.getElementById('export-excel-btn').onclick = function() {
          if (!pickSearchData) return;
          const sort_field = document.getElementById('pick-sort-field').value;
          const sort_order = document.getElementById('pick-sort-order').value;
          
          // 準備匯出資料
          let exportData = [];
          for (const [db, rows] of Object.entries(pickSearchData)) {
            let sortedRows = sortRows(rows, sort_field, sort_order);
            const dbName = db === 'customer_need' ? '客戶需求表' : 
                          db === 'purchase_shipping' ? '採購與出貨表' : '庫存與採購需求表';
            
            // 新增分隔行
            if (exportData.length > 0) {
              exportData.push({});
            }
            exportData.push({ 'MIC需求起日': dbName });
            exportData.push({});
            
            // 新增標題行
            exportData.push({
              'MIC需求起日': 'MIC需求起日',
              'MIC需求訖日': 'MIC需求訖日',
              '料號': '料號',
              '版本': '版本',
              '產品中文名稱': '產品中文名稱',
              '數量': '數量',
              '單價': '單價',
              'PO單號': 'PO單號',
              '庫存': '庫存'
            });
            
            // 新增資料行
            sortedRows.forEach(row => {
              exportData.push({
                'MIC需求起日': row['MIC需求起日'] || '',
                'MIC需求訖日': row['MIC需求訖日'] || '',
                '料號': row['料號'] || '',
                '版本': row['版本'] || '',
                '產品中文名稱': row['產品中文名稱'] || '',
                '數量': row['數量'] || '',
                '單價': row['單價'] || '',
                'PO單號': row['PO單號'] || '',
                '庫存': row['庫存'] || ''
              });
            });
          }
          
          // 轉換為CSV格式
          const fields = ['MIC需求起日', 'MIC需求訖日', '料號', '版本', '產品中文名稱', '數量', '單價', 'PO單號', '庫存'];
          let csvContent = '\uFEFF'; // BOM for UTF-8
          csvContent += fields.join(',') + '\n';
          
          exportData.forEach(row => {
            const values = fields.map(field => {
              const value = row[field] || '';
              return '"' + value.toString().replace(/"/g, '""') + '"';
            });
            csvContent += values.join(',') + '\n';
          });
          
          // 下載檔案
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          const today = new Date().toISOString().split('T')[0];
          link.setAttribute('download', `撿貨資訊表_${today}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };
    </script>
  </body>
</html>